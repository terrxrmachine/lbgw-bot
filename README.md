# LBGW Telegram Bot

Телеграм-бот для управления отзывами и просмотра статистики сайта Lucky Bali Group.

## Функционал

### 1. Менеджер отзывов
- **Автоматические уведомления**: получение уведомлений о новых отзывах с сайта
- **Модерация через inline-кнопки**:
  - ✅ Approve — публикация отзыва на сайте
  - ❌ Reject — отклонение и удаление отзыва
- **Публикация в канал** (опционально): одобренные отзывы могут автоматически публиковаться в канал отзывов

### 2. Статистика сайта (Яндекс.Метрика)
- **Команда `/stats [период]`** — получение подробной статистики:
  - Количество посетителей
  - Количество визитов
  - Количество просмотров страниц
  - ТОП-5 самых популярных разделов

### 3. Поддерживаемые периоды
- `today` — сегодня
- `yesterday` — вчера
- `7d` — последние 7 дней
- `30d` — последние 30 дней
- `YYYY-MM` — конкретный месяц (например, `2025-01`)
- `YYYY-MM-DD` — конкретный день (например, `2025-01-15`)
- `YYYY-MM-DD..YYYY-MM-DD` — диапазон дат (например, `2025-01-01..2025-01-31`)

## Установка

### 1. Клонирование и установка зависимостей

```bash
cd lbgw-bot
npm install
```

### 2. Настройка переменных окружения

Скопируйте `.env.example` в `.env` и заполните значения:

```bash
cp .env.example .env
```

#### Обязательные переменные

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=7616206547:AAGZX9Uu4As9UdM3Lth2dVE7J-cfMaffvS4
TELEGRAM_CHAT_ID=6626945924
# TELEGRAM_REVIEWS_CHANNEL=@your_reviews_channel  # Optional

# LBGW Website API
LBGW_API_URL=http://localhost:3000
REVIEWS_PUBLISH_API_KEY=lbgw_publish_reviews_secure_key_2025

# Yandex Metrica (опционально)
YM_COUNTER_ID=your_counter_id
YM_OAUTH_TOKEN=your_oauth_token
```

### 3. Настройка Telegram бота

1. Бот: `@feedback_lucky_bali_group_bot` (токен уже в `.env.example`)
2. Все взаимодействие происходит через интерфейс бота в личных сообщениях
3. **Канал не требуется** — вся модерация отзывов осуществляется через бота

### 4. Получение OAuth токена Яндекс.Метрики (опционально)

1. Перейдите на https://oauth.yandex.ru/
2. Зарегистрируйте приложение с доступом к Метрике
3. Получите OAuth токен
4. Найдите ID счётчика в интерфейсе Яндекс.Метрики

## Запуск

### Development (с hot-reload)
```bash
npm run dev
```

### Production

```bash
# Сборка
npm run build

# Запуск
npm start
```

## Команды бота

### `/start`
Приветственное сообщение со списком доступных команд.

### `/help`
Подробная справка по использованию бота.

### `/stats [период]`
Получение статистики из Яндекс.Метрики за указанный период.

### `/site_stats`
Получение статистики сайта (количество отзывов, статус CMS).

**Примеры:**
```
/stats today
/stats 30d
/stats 2025-01
/stats 2025-01-01..2025-01-31
```

## Структура проекта

```
lbgw-bot/
├── src/
│   ├── config/
│   │   └── index.ts          # Конфигурация и валидация переменных окружения
│   ├── handlers/
│   │   ├── commands.ts       # Обработчики команд (/start, /help, /stats)
│   │   └── reviews.ts        # Обработка callback от кнопок отзывов
│   ├── services/
│   │   ├── lbgw-api.ts      # Клиент API сайта LBGW
│   │   └── yandex-metrica.ts # Клиент Яндекс.Метрики
│   ├── types/
│   │   └── index.ts         # TypeScript типы
│   ├── utils/
│   │   └── logger.ts        # Логирование
│   └── index.ts             # Точка входа
├── .env.example             # Пример переменных окружения
├── package.json
├── tsconfig.json
└── README.md
```

## Интеграция с сайтом LBGW

Бот автоматически интегрируется с API сайта для:

1. **Публикации отзывов**: `POST /api/reviews/publish`
   - Требует API ключ в заголовке `X-API-Key`
   - Одобряет (публикует) или отклоняет (удаляет) отзывы

2. **Получения уведомлений**: Webhook от сайта при создании нового отзыва
   - Сайт отправляет уведомление с inline-кнопками в Telegram

## Безопасность

- ✅ API ключ для авторизации запросов к сайту
- ✅ Валидация обязательных переменных окружения при старте
- ✅ Обработка ошибок и логирование
- ✅ Graceful shutdown при завершении процесса

## Логирование

Бот использует централизованное логирование с уровнями:
- `INFO` — информационные сообщения
- `SUCCESS` — успешные операции
- `WARN` — предупреждения
- `ERROR` — ошибки с деталями
- `DEBUG` — отладочная информация (только в dev режиме)

## Возможные улучшения

- [ ] Еженедельные автоматические отчёты (cron)
- [ ] Экспорт статистики в Excel/PDF
- [ ] Фильтрация отзывов по языку
- [ ] Расширенная аналитика (воронки, конверсии)
- [ ] Webhook режим вместо polling
- [ ] Поддержка нескольких администраторов

## Поддержка

При возникновении проблем проверьте:
1. Правильность токена бота и chat ID
2. Доступность API сайта LBGW
3. Корректность OAuth токена Яндекс.Метрики
4. Логи бота в консоли

## Лицензия

MIT
